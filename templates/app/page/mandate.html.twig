{# @var \App\Entity\Mandate mandate #}
{# @var int rank #}

{% extends 'app/base.html.twig' %}
{% import 'macros.html.twig' as macros %}

{% block html_class %}bg-dark-pattern{% endblock %}
{% block body_class %}bg-transparent{% endblock %}

{% block title %}
    {{ mandate.politician.firstName }} {{ mandate.politician.lastName }}
    • {{ mandate.institutionTitle.title.name }}
    • {{ mandate.beginDate|date }} - {{ (mandate.ceasingDate ? mandate.ceasingDate : mandate.endDate)|date }}
{% endblock %}
{% block head_meta_og_image %}{{ app.request.getSchemeAndHttpHost ~ macros.politician_photo_url(mandate.politician) }}{% endblock %}

{% block head_meta %}
    {{ parent() }}
    <meta name="description" content="{{ 'meta_description.mandate'|trans }}">
    <style type="text/css">#categories-pie-chart { height: 15rem; }</style>
{% endblock %}

{% set emptyHtml = '<p>&nbsp;</p>' %}

{% block main %}
    <main>
        <section>
            {% include "app/component/section/politician-mandate-points.html.twig" with {
                politician: mandate.politician,
                mandate: mandate,
                rank: rank,
                is_mandate_page: true
            } only %}
        </section>
        {% if mandate.competenceCategoryStats|length %}
            <div class="bg-primary pt-4 pb-2 text-center">
                <div class="container">
                    <div class="row text-white mb-3">
                        <div class="col">
                            <h2>{{ "title.points_by_category"|trans }}</h2>
                        </div>
                    </div>
                    <div class="row">
                        {% for categoryStats in mandate.competenceCategoryStatsByParentCategory %}
                            {# @var \App\Entity\MandateCompetenceCategoryStats categoryStats #}
                            <div class="col-12 col-lg mb-4">
                                <div class="bg-light-pattern py-4 px-3 rounded">
                                    <h5>{{ categoryStats.competenceCategory.nameWithParent }}</h5>
                                    <div class="font-size-2">
                                        <strong class="text-info">{{ categoryStats.competenceUsesPoints }}</strong>
                                        <small>{{ "text.points"|trans({"%count%": categoryStats.competenceUsesPoints}) }}</small>
                                    </div>
                                </div>
                            </div>

                            {% if loop.index0 and not loop.index0 % 2 %}
                    </div><div class="row">
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% if mandate.competenceCategoryStats|length > 1 %}
                {% set chart_items = [] %}
                {% for categoryStats in mandate.competenceCategoryStats %}
                    {% set chart_items = chart_items|merge([{
                        y: categoryStats.competenceUsesPoints,
                        label: categoryStats.competenceCategory.nameWithParent
                    }]) %}
                {% endfor %}

                <div class="bg-dark py-4">
                    <div
                        id="categories-pie-chart"
                        class="w-100"
                        data-chart-items="{{ chart_items|json_encode }}"
                    ></div>
                </div>
            {% endif %}
            <div class="bg-light py-5">
                <div class="container">
                    <div class="row text-center mb-3">
                        <div class="col">
                            <h2>{{ "title.used_competences"|trans }}</h2>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            {% for competenceUse in mandate.competenceUses %}
                                {# @var \App\Entity\CompetenceUse competenceUse #}
                                <div class="card{% if not loop.last %} mb-4{% endif %}">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col">
                                                <div
                                                    class="badge badge-primary mr-3"
                                                    data-toggle="tooltip" data-placement="right"
                                                    title="{{ competenceUse.useDate|ago }}"
                                                >
                                                    {{ competenceUse.useDate|date }}
                                                </div>
                                                {{ competenceUse.competence.category.nameWithParent }}
                                            </div>
                                            <div class="col-auto">
                                                <strong class="text-info">
                                                    {{ competenceUse.competence.points }}
                                                    {% if competenceUse.multiplied %}
                                                        <small class="text-danger font-weight-bold mr-1">
                                                            <samp>x{{ competence_use_multiplication_factor }}</samp>
                                                        </small>
                                                    {% endif %}
                                                </strong>
                                                {{ "text.points"|trans({"%count%": (competenceUse.competence.points * (
                                                    competenceUse.multiplied ? competence_use_multiplication_factor : 1
                                                ))}) }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="mb-0 alert alert-info">
                                            <span class="text-muted">{{ "label.competence"|trans }}: </span>
                                            {{ competenceUse.competence.name }}
                                        </h6>
                                        {% if competenceUse.description and competenceUse.description != emptyHtml %}
                                            <div class="mt-3 raw-html">
                                                {{ competenceUse.description|raw }}
                                            </div>
                                        {% endif %}
                                        {% if competenceUse.sourceLink %}
                                            <div class="mt-3">
                                                <a
                                                    href="{{ competenceUse.sourceLink }}"
                                                    target="_blank"
                                                    class="btn btn-sm btn-outline-info"
                                                >{{ "action.view_source"|trans }}</a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="bg-secondary py-5 text-center">
                <h3 class="mb-0">
                    {{ "title.no_used_competences_found"|trans }}
                </h3>
            </div>
        {% endif %}
    </main>
    {% include 'app/component/section/footer.html.twig' only %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    {% if mandate.competenceCategoryStats|length > 1 %}
        <script src="{{ asset('js/canvasjs.min.js') }}"></script>
        <script>
            window.onload = function () {
                var wrap = document.getElementById("categories-pie-chart");
                if (!wrap) {
                    return;
                }

                var chart = new CanvasJS.Chart(wrap, {
                    theme: "dark1",
                    backgroundColor: "transparent",
                    data: [{
                        type: "pie",
                        indexLabelFontSize: 18,
                        radius: 80,
                        //indexLabel: "{label} ({y})",
                        yValueFormatString: "###0.0 {{ "label.points"|trans|lower|escape('js') }}",
                        dataPoints: JSON.parse(wrap.getAttribute('data-chart-items'))
                    }]
                });
                chart.render();
            };
        </script>
    {% endif %}
{% endblock %}

